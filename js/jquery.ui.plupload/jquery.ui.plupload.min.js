;(function(e,t,n,r){function s(e){return n.translate(e)||e}function o(e){e.id=e.attr("id"),e.html('<div class="plupload_wrapper"><div class="ui-widget-content plupload_container"><div class="ui-state-default ui-widget-header plupload_header"><div class="plupload_header_content"><div class="plupload_logo"> </div><div class="plupload_header_title">'+s("Select files")+"</div>"+'<div class="plupload_header_text">'+s("Add files to the upload queue and click the start button.")+"</div>"+'<div class="plupload_view_switch">'+'<input type="radio" id="'+e.id+'_view_list" name="view_mode_'+e.id+'" checked="checked" /><label class="plupload_button" for="'+e.id+'_view_list" data-view="list">'+s("List")+"</label>"+'<input type="radio" id="'+e.id+'_view_thumbs" name="view_mode_'+e.id+'" /><label class="plupload_button"  for="'+e.id+'_view_thumbs" data-view="thumbs">'+s("Thumbnails")+"</label>"+"</div>"+"</div>"+"</div>"+'<table class="plupload_filelist plupload_filelist_header ui-widget-header">'+"<tr>"+'<td class="plupload_cell plupload_file_name">'+s("Filename")+"</td>"+'<td class="plupload_cell plupload_file_status">'+s("Status")+"</td>"+'<td class="plupload_cell plupload_file_size">'+s("Size")+"</td>"+'<td class="plupload_cell plupload_file_action">&nbsp;</td>'+"</tr>"+"</table>"+'<div class="plupload_content">'+'<div class="plupload_droptext">'+s("Drag files here.")+"</div>"+'<ul class="plupload_filelist_content"> </ul>'+'<div class="plupload_clearer">&nbsp;</div>'+"</div>"+'<table class="plupload_filelist plupload_filelist_footer ui-widget-header">'+"<tr>"+'<td class="plupload_cell plupload_file_name">'+'<div class="plupload_buttons"><!-- Visible -->'+'<a class="plupload_button plupload_add">'+s("Add Files")+"</a>&nbsp;"+'<a class="plupload_button plupload_start">'+s("Start Upload")+"</a>&nbsp;"+'<a class="plupload_button plupload_stop plupload_hidden">'+s("Stop Upload")+"</a>&nbsp;"+"</div>"+'<div class="plupload_started plupload_hidden"><!-- Hidden -->'+'<div class="plupload_progress plupload_right">'+'<div class="plupload_progress_container"></div>'+"</div>"+'<div class="plupload_cell plupload_upload_status"></div>'+'<div class="plupload_clearer">&nbsp;</div>'+"</div>"+"</td>"+'<td class="plupload_file_status"><span class="plupload_total_status">0%</span></td>'+'<td class="plupload_file_size"><span class="plupload_total_file_size">0 kb</span></td>'+'<td class="plupload_file_action"></td>'+"</tr>"+"</table>"+"</div>"+'<input class="plupload_count" value="0" type="hidden">'+"</div>")}var i={};r.widget("ui.plupload",{widgetEventPrefix:"",contents_bak:"",options:{browse_button_hover:"ui-state-hover",browse_button_active:"ui-state-active",filters:{},buttons:{browse:!0,start:!0,stop:!0},views:{list:!0,thumbs:!1,active:"list",remember:!0},thumb_width:100,thumb_height:60,multiple_queues:!0,dragdrop:!0,autostart:!1,sortable:!1,rename:!1},FILE_COUNT_ERROR:-9001,_create:function(){var e=this.element.attr("id");e||(e=n.guid(),this.element.attr("id",e)),this.id=e,this.contents_bak=this.element.html(),o(this.element),this.container=r(".plupload_container",this.element).attr("id",e+"_container"),this.content=r(".plupload_content",this.element),r.fn.resizable&&this.container.resizable({handles:"s",minHeight:300}),this.filelist=r(".plupload_filelist_content",this.container).attr({id:e+"_filelist",unselectable:"on"}),this.browse_button=r(".plupload_add",this.container).attr("id",e+"_browse"),this.start_button=r(".plupload_start",this.container).attr("id",e+"_start"),this.stop_button=r(".plupload_stop",this.container).attr("id",e+"_stop"),this.thumbs_switcher=r("#"+e+"_view_thumbs"),this.list_switcher=r("#"+e+"_view_list"),r.ui.button&&(this.browse_button.button({icons:{primary:"ui-icon-circle-plus"},disabled:!0}),this.start_button.button({icons:{primary:"ui-icon-circle-arrow-e"},disabled:!0}),this.stop_button.button({icons:{primary:"ui-icon-circle-close"}}),this.list_switcher.button({text:!1,icons:{secondary:"ui-icon-grip-dotted-horizontal"}}),this.thumbs_switcher.button({text:!1,icons:{secondary:"ui-icon-image"}})),this.progressbar=r(".plupload_progress_container",this.container),r.ui.progressbar&&this.progressbar.progressbar(),this.counter=r(".plupload_count",this.element).attr({id:e+"_count",name:e+"_count"}),this._initUploader()},_initUploader:function(){var e=this,t=this.id,o,u={container:t+"_buttons",browse_button:t+"_browse",required_features:{},filters:{}};r(".plupload_buttons",this.element).attr("id",t+"_buttons"),e.options.dragdrop&&(this.filelist.parent().attr("id",this.id+"_dropbox"),u.drop_element=this.id+"_dropbox"),this.filelist.on("click",function(t){r(t.target).hasClass("plupload_action_icon")&&(e.removeFile(r(t.target).closest(".plupload_file").attr("id")),t.preventDefault())}),e.options.views.thumbs&&(u.required_features.display_media=!0),e.options.max_file_count&&(u.filters.max_file_count=e.options.max_file_count),o=this.uploader=i[t]=new n.Uploader(r.extend(this.options,u)),this.options=o.getOption(),n.addFileFilter("max_file_count",function(t,n,r){t<=this.files.length-(this.total.uploaded+this.total.failed)?(e.browse_button.button("disable"),this.disableBrowse(),this.trigger("Error",{code:e.FILE_COUNT_ERROR,message:s("File count error."),file:n}),r(!1)):r(!0)}),o.bind("Error",function(t,r){var i,o="";i="<strong>"+r.message+"</strong>";switch(r.code){case n.FILE_EXTENSION_ERROR:o=n.sprintf(s("File: %s"),r.file.name);break;case n.FILE_SIZE_ERROR:o=n.sprintf(s("File: %s, size: %d, max file size: %d"),r.file.name,n.formatSize(r.file.size),n.formatSize(n.parseSize(t.getOption("filters").max_file_size)));break;case n.FILE_DUPLICATE_ERROR:o=n.sprintf(s("%s already present in the queue."),r.file.name);break;case e.FILE_COUNT_ERROR:o=n.sprintf(s("Upload element accepts only %d file(s) at a time. Extra files were stripped."),t.getOption("filters").max_file_count||0);break;case n.IMAGE_FORMAT_ERROR:o=s("Image format either wrong or not supported.");break;case n.IMAGE_MEMORY_ERROR:o=s("Runtime ran out of available memory.");break;case n.HTTP_ERROR:o=s("Upload URL might be wrong or doesn't exist.")}i+=" <br /><i>"+o+"</i>",e._trigger("error",null,{up:t,error:r}),r.code===n.INIT_ERROR?setTimeout(function(){e.destroy()},1):e.notify("error",i)}),o.bind("PostInit",function(t){e.options.buttons.browse?e.browse_button.button("enable"):(e.browse_button.button("disable").hide(),t.disableBrowse(!0)),e.options.buttons.start||e.start_button.button("disable").hide(),e.options.buttons.stop||e.stop_button.button("disable").hide(),!e.options.unique_names&&e.options.rename&&e._enableRenaming(),e.options.dragdrop&&t.features.dragdrop&&e.filelist.parent().addClass("plupload_dropbox"),e._enableViewSwitcher(),e.start_button.click(function(t){r(this).button("option","disabled")||e.start(),t.preventDefault()}),e.stop_button.click(function(t){e.stop(),t.preventDefault()}),e._trigger("ready",null,{up:t})}),o.init(),o.bind("FileFiltered",function(t,n){e._addFiles(n)}),o.bind("FilesAdded",function(t,n){e._trigger("selected",null,{up:t,files:n}),e.options.sortable&&r.ui.sortable&&e._enableSortingList(),e._trigger("updatelist",null,{filelist:e.filelist}),e.options.autostart&&setTimeout(function(){e.start()},10)}),o.bind("FilesRemoved",function(t,n){r.ui.sortable&&e.options.sortable&&r("tbody",e.filelist).sortable("destroy"),r.each(n,function(e,t){r("#"+t.id).toggle("highlight",function(){r(this).remove()})}),t.files.length&&e.options.sortable&&r.ui.sortable&&e._enableSortingList(),e._trigger("updatelist",null,{filelist:e.filelist}),e._trigger("removed",null,{up:t,files:n})}),o.bind("QueueChanged",function(){e._handleState()}),o.bind("StateChanged",function(t){e._handleState(),n.STARTED===t.state?e._trigger("started",null,{up:this.uploader}):n.STOPPED===t.state&&e._trigger("stopped",null,{up:this.uploader})}),o.bind("UploadFile",function(t,n){e._handleFileStatus(n)}),o.bind("FileUploaded",function(t,n,r){e._handleFileStatus(n),e._trigger("uploaded",null,{up:t,file:n,result:r})}),o.bind("UploadProgress",function(t,n){e._handleFileStatus(n),e._updateTotalProgress(),e._trigger("progress",null,{up:t,file:n})}),o.bind("UploadComplete",function(t,n){e._addFormFields(),e._trigger("complete",null,{up:t,files:n})})},_setOption:function(e,t){var n=this;e=="buttons"&&typeof t=="object"&&(t=r.extend(n.options.buttons,t),t.browse?(n.browse_button.button("enable").show(),n.uploader.disableBrowse(!1)):(n.browse_button.button("disable").hide(),n.uploader.disableBrowse(!0)),t.start?n.start_button.button("enable").show():n.start_button.button("disable").hide(),t.stop?n.start_button.button("enable").show():n.stop_button.button("disable").hide()),n.uploader.setOption(e,t)},start:function(){this.uploader.start()},stop:function(){this.uploader.stop()},enable:function(){this.browse_button.button("enable"),this.uploader.disableBrowse(!1)},disable:function(){this.browse_button.button("disable"),this.uploader.disableBrowse(!0)},getFile:function(e){var t;return typeof e=="number"?t=this.uploader.files[e]:t=this.uploader.getFile(e),t},getFiles:function(){return this.uploader.files},removeFile:function(e){n.typeOf(e)==="string"&&(e=this.getFile(e)),this.uploader.removeFile(e)},clearQueue:function(){this.uploader.splice()},getUploader:function(){return this.uploader},refresh:function(){this.uploader.refresh()},notify:function(e,t){var n=r('<div class="plupload_message"><span class="plupload_message_close ui-icon ui-icon-circle-close" title="'+s("Close")+'"></span>'+'<p><span class="ui-icon"></span>'+t+"</p>"+"</div>");n.addClass("ui-state-"+(e==="error"?"error":"highlight")).find("p .ui-icon").addClass("ui-icon-"+(e==="error"?"alert":"info")).end().find(".plupload_message_close").click(function(){n.remove()}).end(),r(".plupload_header",this.container).append(n)},destroy:function(){this.uploader.destroy(),r(".plupload_button",this.element).unbind(),r.ui.button&&r(".plupload_add, .plupload_start, .plupload_stop",this.container).button("destroy"),r.ui.progressbar&&this.progressbar.progressbar("destroy"),r.ui.sortable&&this.options.sortable&&r("tbody",this.filelist).sortable("destroy"),this.element.empty().html(this.contents_bak),this.contents_bak="",r.Widget.prototype.destroy.apply(this)},_handleState:function(){var e=this.uploader,t=e.files.length-(e.total.uploaded+e.total.failed),i=e.getOption("filters").max_file_count||0;n.STARTED===e.state?(r([]).add(this.stop_button).add(".plupload_started").removeClass("plupload_hidden"),this.start_button.button("disable"),this.options.multiple_queues||(this.browse_button.button("disable"),e.disableBrowse()),r(".plupload_upload_status",this.element).html(n.sprintf(s("Uploaded %d/%d files"),e.total.uploaded,e.files.length)),r(".plupload_header_content",this.element).addClass("plupload_header_content_bw")):n.STOPPED===e.state&&(r([]).add(this.stop_button).add(".plupload_started").addClass("plupload_hidden"),t?this.start_button.button("enable"):this.start_button.button("disable"),this.options.multiple_queues&&r(".plupload_header_content",this.element).removeClass("plupload_header_content_bw"),this.options.multiple_queues&&i&&i>t&&(this.browse_button.button("enable"),e.disableBrowse(!1)),this._updateTotalProgress()),e.total.queued===0?r(".ui-button-text",this.browse_button).html(s("Add Files")):r(".ui-button-text",this.browse_button).html(n.sprintf(s("%d files queued"),e.total.queued)),e.refresh()},_handleFileStatus:function(e){var t=r("#"+e.id),i,s;if(!t.length)return;switch(e.status){case n.DONE:i="plupload_done",s="plupload_action_icon ui-icon ui-icon-circle-check";break;case n.FAILED:i="ui-state-error plupload_failed",s="plupload_action_icon ui-icon ui-icon-alert";break;case n.QUEUED:i="plupload_delete",s="plupload_action_icon ui-icon ui-icon-circle-minus";break;case n.UPLOADING:i="ui-state-highlight plupload_uploading",s="plupload_action_icon ui-icon ui-icon-circle-arrow-w";var o=r(".plupload_scroll",this.container),u=o.scrollTop(),a=o.height(),f=t.position().top+t.height();a<f&&o.scrollTop(u+f-a),t.find(".plupload_file_percent").html(e.percent+"%").end().find(".plupload_file_progress").css("width",e.percent+"%").end().find(".plupload_file_size").html(n.formatSize(e.size))}i+=" ui-state-default plupload_file",t.attr("class",i).find(".plupload_action_icon").attr("class",s)},_updateTotalProgress:function(){var e=this.uploader;this.filelist[0].scrollTop=this.filelist[0].scrollHeight,this.progressbar.progressbar("value",e.total.percent),this.element.find(".plupload_total_status").html(e.total.percent+"%").end().find(".plupload_total_file_size").html(n.formatSize(e.total.size)).end().find(".plupload_upload_status").html(n.sprintf(s("Uploaded %d/%d files"),e.total.uploaded,e.files.length))},_displayThumbs:function(){function f(e,t,n){var r;e.on(t,function(){clearTimeout(r),r=setTimeout(function(){clearTimeout(r),n()},300)})}function l(){if(!t||!i){var n=r(".plupload_file:eq(0)",e.filelist);t=n.outerWidth(!0),i=n.outerHeight(!0)}var u=e.content.width(),a=e.content.height();s=Math.floor(u/t),o=s*(Math.ceil(a/i)+1)}function c(){var t=Math.floor(e.content.scrollTop()/i)*s;u=r(".plupload_file .plupload_file_thumb",e.filelist).slice(t,t+o).filter(".plupload_thumb_toload").get()}function h(){function t(){if(e.view_mode!=="thumbs")return;l(),c(),d()}r.fn.resizable&&f(e.container,"resize",t),f(e.window,"resize",t),f(e.content,"scroll",t),e.element.on("viewchanged selected",t),t()}function p(t,i){var s=new n.Image;s.onload=function(){var i=r("#"+t.id+" .plupload_file_thumb",e.filelist);this.embed(i[0],{width:e.options.thumb_width,height:e.options.thumb_height,crop:!0,preserveHeaders:!1,swf_url:n.resolveUrl(e.options.flash_swf_url),xap_url:n.resolveUrl(e.options.silverlight_xap_url)})},s.bind("embedded error",function(n){r("#"+t.id,e.filelist).find(".plupload_file_thumb").removeClass("plupload_thumb_loading").addClass("plupload_thumb_"+n.type),this.destroy(),setTimeout(i,1)}),r("#"+t.id,e.filelist).find(".plupload_file_thumb").removeClass("plupload_thumb_toload").addClass("plupload_thumb_loading"),s.load(t.getSource())}function d(){if(e.view_mode!=="thumbs"||a)return;c();if(!u.length)return;a=!0,p(e.getFile(r(u.shift()).closest(".plupload_file").attr("id")),function(){a=!1,d()})}var e=this,t,i,s,o=0,u=[],a=!1;if(!this.options.views.thumbs)return;this.element.on("selected",function v(){e.element.off("selected",v),h()})},_addFiles:function(e){var t=this,i,s="";i='<li class="plupload_file ui-state-default plupload_delete" id="{id}" style="width:{thumb_width}px;"><div class="plupload_file_thumb plupload_thumb_toload" style="width: {thumb_width}px; height: {thumb_height}px;"><div class="plupload_file_dummy ui-widget-content" style="line-height: {thumb_height}px;"><span class="ui-state-disabled">{ext} </span></div></div><div class="plupload_file_status"><div class="plupload_file_progress ui-widget-header" style="width: 0%"> </div><span class="plupload_file_percent">{percent} </span></div><div class="plupload_file_name" title="{name}"><span class="plupload_file_name_wrapper">{name} </span></div><div class="plupload_file_action"><div class="plupload_action_icon ui-icon ui-icon-circle-minus"> </div></div><div class="plupload_file_size">{size} </div><div class="plupload_file_fields"> </div></li>',n.typeOf(e)!=="array"&&(e=[e]),r.each(e,function(e,r){var o=r.name.match(/\.([^.]+)$/),u=o&&o[1].toLowerCase()||"none";s+=i.replace(/\{(\w+)\}/g,function(e,i){switch(i){case"thumb_width":case"thumb_height":return t.options[i];case"size":return n.formatSize(r.size);case"ext":return u;default:return r[i]||""}})}),t.filelist.append(s)},_addFormFields:function(){var e=this;r(".plupload_file_fields",this.filelist).html(""),n.each(this.uploader.files,function(t,i){var s="",o=e.id+"_"+i;t.target_name&&(s+='<input type="hidden" name="'+o+'_tmpname" value="'+n.xmlEncode(t.target_name)+'" />'),s+='<input type="hidden" name="'+o+'_name" value="'+n.xmlEncode(t.name)+'" />',s+='<input type="hidden" name="'+o+'_status" value="'+(t.status===n.DONE?"done":"failed")+'" />',r("#"+t.id).find(".plupload_file_fields").html(s)}),this.counter.val(this.uploader.files.length)},_viewChanged:function(e){this.options.views.remember&&r.cookie&&r.cookie("plupload_ui_view",e,{expires:7,path:"/"}),n.ua.browser==="IE"&&n.ua.version<7&&this.content.attr("style",'height:expression(document.getElementById("'+this.id+"_container"+'").clientHeight - '+(e==="list"?132:102)+")"),this.container.removeClass("plupload_view_list plupload_view_thumbs").addClass("plupload_view_"+e),this.view_mode=e,this._trigger("viewchanged",null,{view:e})},_enableViewSwitcher:function(){var e=this,t,i=r(".plupload_view_switch",this.container),s,o;n.each(["list","thumbs"],function(t){e.options.views[t]||i.find('[for="'+e.id+"_view_"+t+'"], #'+e.id+"_view_"+t).remove()}),s=i.find(".plupload_button"),s.length===1?(i.hide(),t=s.eq(0).data("view"),this._viewChanged(t)):r.ui.button&&s.length>1?(this.options.views.remember&&r.cookie&&(t=r.cookie("plupload_ui_view")),~n.inArray(t,["list","thumbs"])||(t=this.options.views.active),i.show().buttonset().find(".ui-button").click(function(n){t=r(this).data("view"),e._viewChanged(t),n.preventDefault()}),o=i.find('[for="'+e.id+"_view_"+t+'"]'),o.length&&o.trigger("click")):(i.show(),this._viewChanged(this.options.views.active)),this.options.views.thumbs&&this._displayThumbs()},_enableRenaming:function(){var e=this;this.filelist.dblclick(function(t){var n=r(t.target),i,s,o,u,a="";if(!n.hasClass("plupload_file_name_wrapper"))return;s=e.uploader.getFile(n.closest(".plupload_file")[0].id),u=s.name,o=/^(.+)(\.[^.]+)$/.exec(u),o&&(u=o[1],a=o[2]),i=r('<input class="plupload_file_rename" type="text" />').width(n.width()).insertAfter(n.hide()),i.val(u).blur(function(){n.show().parent().scrollLeft(0).end().next().remove()}).keydown(function(e){var t=r(this);r.inArray(e.keyCode,[13,27])!==-1&&(e.preventDefault(),e.keyCode===13&&(s.name=t.val()+a,n.html(s.name)),t.blur())})[0].focus()})},_enableSortingList:function(){var e=this;if(r(".plupload_file",this.filelist).length<2)return;r("tbody",this.filelist).sortable("destroy"),this.filelist.sortable({items:".plupload_delete",cancel:"object, .plupload_clearer",stop:function(){var t=[];r.each(r(this).sortable("toArray"),function(n,r){t[t.length]=e.uploader.getFile(r)}),t.unshift(t.length),t.unshift(0),Array.prototype.splice.apply(e.uploader.files,t)}})}})})(window,document,plupload,jQuery);